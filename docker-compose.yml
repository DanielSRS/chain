version: "3.8"

services:
  mqtt-broker:
    image: eclipse-mosquitto:latest
    container_name: mqtt-broker
    ports:
      - "1883:1883" # MQTT default port
      - "9001:9001" # WebSockets port
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    restart: unless-stopped

  server:
    build:
      context: ./apps/server
      dockerfile: Dockerfile
    container_name: elysia-server
    ports:
      - "3000:3000"
    volumes:
      - ./apps/server:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
    restart: unless-stopped
    depends_on:
      - mqtt-broker

  # Service to install dependencies for type support in the editor
  deps-installer:
    image: node:18-alpine
    container_name: deps-installer
    working_dir: /workspace
    command: >
      sh -c "cd /workspace &&
             yarn install &&
             echo 'Dependencies installed successfully for editor type support'"
    volumes:
      - ./:/workspace
    profiles:
      - deps
