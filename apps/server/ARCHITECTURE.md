# üèóÔ∏è Arquitetura do Servidor de Recarga de VEs com Blockchain

## üìã √çndice

1. [Vis√£o Geral](#vis√£o-geral)
2. [Arquitetura do Sistema](#arquitetura-do-sistema)
3. [Componentes Principais](#componentes-principais)
4. [Fluxo de Dados](#fluxo-de-dados)
5. [Endpoints da API](#endpoints-da-api)
6. [Blockchain e Consenso](#blockchain-e-consenso)
7. [Comunica√ß√£o MQTT](#comunica√ß√£o-mqtt)
8. [Estrutura de Arquivos](#estrutura-de-arquivos)
9. [Diagramas](#diagramas)
10. [Configura√ß√£o e Deploy](#configura√ß√£o-e-deploy)

---

## üéØ Vis√£o Geral

O servidor de recarga de ve√≠culos el√©tricos √© uma aplica√ß√£o Node.js moderna constru√≠da com:

- **Framework**: [Elysia](https://elysiajs.com/) (TypeScript-first web framework)
- **Runtime**: [Bun](https://bun.sh/) (JavaScript runtime perform√°tico)
- **Blockchain**: Ethereum com smart contracts Solidity
- **Consensus**: Substitui√ß√£o do Paxos por blockchain Ethereum
- **Comunica√ß√£o**: HTTP REST + MQTT + WebSockets
- **Database**: Blockchain como ledger distribu√≠do + cache local

### üéâ Migra√ß√£o Conclu√≠da: Paxos ‚Üí Blockchain

O sistema foi **migrado com sucesso** de uma arquitetura complexa (Paxos + XState) para uma **solu√ß√£o blockchain padronizada**:

- ‚ùå **Removido**: Consenso Paxos customizado (~500 linhas)
- ‚ùå **Removido**: State machines XState complexas
- ‚ùå **Removido**: Abstra√ß√µes curry desnecess√°rias
- ‚úÖ **Adicionado**: Smart contracts Ethereum (~100 linhas)
- ‚úÖ **Adicionado**: Servi√ßos blockchain padronizados
- ‚úÖ **Resultado**: 70% redu√ß√£o de complexidade

---

## üèóÔ∏è Arquitetura do Sistema

### Modelo Multi-Empresa Descentralizado

```mermaid
graph TB
    subgraph "üöó Clientes (Carros)"
        Car1[Carro A]
        Car2[Carro B]
        Car3[Carro C]
    end

    subgraph "üè¢ Empresa A"
        ServerA[Servidor A<br/>:8095]
        StationA1[Posto A1]
        StationA2[Posto A2]
    end

    subgraph "üè¢ Empresa B"
        ServerB[Servidor B<br/>:8096]
        StationB1[Posto B1]
        StationB2[Posto B2]
    end

    subgraph "‚õìÔ∏è Blockchain Network"
        BC[Smart Contract<br/>ChargingConsensus]
        HardhatNode[Hardhat Node<br/>:8545]
    end

    Car1 -.->|MQTT| ServerA
    Car2 -.->|MQTT| ServerA
    Car3 -.->|MQTT| ServerB

    StationA1 -.->|MQTT| ServerA
    StationA2 -.->|MQTT| ServerA
    StationB1 -.->|MQTT| ServerB
    StationB2 -.->|MQTT| ServerB

    ServerA <-->|Ethereum RPC| BC
    ServerB <-->|Ethereum RPC| BC
    BC <--> HardhatNode

    classDef server fill:#e1f5fe
    classDef blockchain fill:#f3e5f5
    classDef client fill:#e8f5e8
    classDef station fill:#fff3e0

    class ServerA,ServerB server
    class BC,HardhatNode blockchain
    class Car1,Car2,Car3 client
    class StationA1,StationA2,StationB1,StationB2 station
```

### Protocolos de Comunica√ß√£o

1. **Empresa ‚Üî Clientes**: MQTT (tempo real)
2. **Empresa ‚Üî Esta√ß√µes**: MQTT (status, comandos)
3. **Empresa ‚Üî Outras Empresas**: Blockchain Ethereum (consenso)
4. **Clientes/Apps ‚Üî Empresa**: HTTP REST (API p√∫blica)

---

## üß© Componentes Principais

### 1. **Servidor Principal** (`blockchain-server.ts`)

```typescript
// Servidor Elysia com integra√ß√£o blockchain
const app = new Elysia()
  .decorate('blockchain', blockchain) // Servi√ßo Ethereum
  .decorate('mqttClient', mqttClient) // Cliente MQTT
  .decorate('companyId', COMPANY_ID) // ID da empresa

  // Endpoints principais
  .get('/', healthCheck)
  .post('/reserve', reserveStation) // Reservar posto
  .post('/start-charging', startCharging) // Iniciar recarga
  .post('/end-charging', endCharging) // Finalizar recarga
  .post('/payment', processPayment); // Processar pagamento
```

### 2. **Servi√ßo Blockchain** (`ethereum-consensus.ts`)

```typescript
export class EthereumConsensus {
  // Conex√£o com blockchain
  private provider: ethers.providers.JsonRpcProvider;
  private wallet: ethers.Wallet;
  private contract: ethers.Contract;

  // M√©todos principais
  async registerStation(companyId: string): Promise<number>;
  async createReservation(
    stationId: number,
    startTime: number,
    endTime: number,
  ): Promise<number>;
  async startCharging(reservationId: number): Promise<void>;
  async completeCharging(
    reservationId: number,
    chargeAmount: number,
  ): Promise<void>;
  async processPayment(reservationId: number, amount: number): Promise<void>;

  // Eventos em tempo real
  onStationRegistered(callback);
  onReservationCreated(callback);
  onChargingCompleted(callback);
}
```

### 3. **Smart Contract** (`ChargingConsensus.sol`)

```solidity
contract ChargingConsensus {
    // Estruturas de dados
    struct Station { uint256 id; string companyId; bool isAvailable; address owner; }
    struct Reservation { uint256 stationId; address user; uint256 startTime; uint256 endTime; bool isActive; uint256 chargeAmount; bool isPaid; }

    // Fun√ß√µes principais
    function registerCompany(string memory companyId) external
    function registerStation(string memory companyId) external
    function createReservation(uint256 stationId, uint256 startTime, uint256 endTime) external
    function startCharging(uint256 reservationId) external
    function completeCharging(uint256 reservationId, uint256 chargeAmount) external
    function processPayment(uint256 reservationId) external payable

    // Eventos
    event StationRegistered(uint256 indexed stationId, string companyId, address owner)
    event ReservationCreated(uint256 indexed reservationId, uint256 stationId, address user)
    event ChargingStarted(uint256 indexed reservationId)
    event ChargingCompleted(uint256 indexed reservationId, uint256 chargeAmount)
    event PaymentProcessed(uint256 indexed reservationId)
}
```

### 4. **Servidor MQTT** (`mqtt-server.ts`)

```typescript
// Cliente MQTT para comunica√ß√£o em tempo real
export const mqttClient = new Paho.Client(mqttHost, mqttPort, wsPath, clientId);

// T√≥picos suportados
const topics = {
  cities: () => ({ data: CITIES, responseTopic: 'cities/response' }),
  routes: ({ departure, destination }) => ({
    data: ComputedRoutes[departure][destination],
    responseTopic: 'routes/response',
  }),
};
```

---

## üîÑ Fluxo de Dados

### Fluxo de Reserva (Multi-Empresa)

```mermaid
sequenceDiagram
    participant Car as üöó Carro
    participant CompanyA as üè¢ Empresa A
    participant Blockchain as ‚õìÔ∏è Blockchain
    participant CompanyB as üè¢ Empresa B
    participant Station as ‚ö° Posto B

    Car->>CompanyA: POST /reserve {stationId: B1, userId: "car123"}
    CompanyA->>CompanyA: Validar dados locais
    CompanyA->>Blockchain: createReservation(B1, startTime, endTime)
    Blockchain->>Blockchain: Validar disponibilidade
    Blockchain->>CompanyB: Event: ReservationCreated
    CompanyB->>Station: MQTT: reserve {stationId: B1}
    Station->>CompanyB: MQTT: status {state: "reserved"}
    Blockchain-->>CompanyA: reservationId: 123
    CompanyA-->>Car: {success: true, reservationId: 123}
```

### Fluxo de Recarga

```mermaid
sequenceDiagram
    participant Car as üöó Carro
    participant Company as üè¢ Empresa
    participant Blockchain as ‚õìÔ∏è Blockchain
    participant Station as ‚ö° Posto

    Car->>Company: POST /start-charging {reservationId: 123}
    Company->>Blockchain: startCharging(123)
    Blockchain->>Company: Event: ChargingStarted
    Company->>Station: MQTT: start {reservationId: 123}
    Station->>Station: Iniciar processo de recarga
    Station->>Company: MQTT: charging {progress: 25%}

    Note over Station: Recarga em progresso...

    Station->>Company: MQTT: completed {chargeAmount: 50kWh}
    Company->>Blockchain: completeCharging(123, 50)
    Blockchain->>Company: Event: ChargingCompleted
    Company-->>Car: {status: "completed", amount: 50}
```

---

## üåê Endpoints da API

### Endpoints Principais

| M√©todo | Endpoint             | Descri√ß√£o                    | Par√¢metros                      |
| ------ | -------------------- | ---------------------------- | ------------------------------- |
| `GET`  | `/`                  | Health check do servidor     | -                               |
| `GET`  | `/blockchain/status` | Status da conex√£o blockchain | -                               |
| `POST` | `/reserve`           | Reservar posto de recarga    | `{stationId, userId}`           |
| `POST` | `/start-charging`    | Iniciar sess√£o de recarga    | `{reservationId, userId}`       |
| `POST` | `/end-charging`      | Finalizar recarga            | `{reservationId, batteryLevel}` |
| `POST` | `/payment`           | Processar pagamento          | `{reservationId, amount}`       |
| `GET`  | `/stations`          | Listar postos dispon√≠veis    | -                               |
| `GET`  | `/suggestions`       | Sugest√µes de postos pr√≥ximos | `{location, radius}`            |

### Endpoints de Registro

| M√©todo | Endpoint             | Descri√ß√£o              | Par√¢metros                     |
| ------ | -------------------- | ---------------------- | ------------------------------ |
| `POST` | `/register-station`  | Registrar novo posto   | `{companyId, location}`        |
| `POST` | `/register-user`     | Registrar novo usu√°rio | `{userId, carModel, location}` |
| `GET`  | `/station-info/{id}` | Informa√ß√µes do posto   | `stationId`                    |

### Endpoints Blockchain

| M√©todo | Endpoint                       | Descri√ß√£o                     | Par√¢metros      |
| ------ | ------------------------------ | ----------------------------- | --------------- |
| `POST` | `/blockchain/transaction`      | Submeter transa√ß√£o            | `{type, data}`  |
| `GET`  | `/blockchain/station/{id}`     | Estado do posto no blockchain | `stationId`     |
| `GET`  | `/blockchain/reservation/{id}` | Dados da reserva              | `reservationId` |

---

## ‚õìÔ∏è Blockchain e Consenso

### Substitui√ß√£o do Paxos

**Antes (Problem√°tico):**

```typescript
// Consenso Paxos customizado - ~500 linhas de c√≥digo complexo
class PaxosConsensus {
  async propose(value) {
    /* l√≥gica complexa */
  }
  async accept(proposal) {
    /* valida√ß√£o manual */
  }
  async commit(value) {
    /* distribui√ß√£o manual */
  }
}
```

**Depois (Simplificado):**

```typescript
// Blockchain Ethereum - ~100 linhas de integra√ß√£o
class EthereumConsensus {
  async submitTransaction(tx) {
    const result = await this.contract.createReservation(
      tx.stationId,
      tx.startTime,
      tx.endTime,
    );
    await result.wait(); // Consenso autom√°tico via blockchain
    return result;
  }
}
```

### Vantagens da Migra√ß√£o

| Aspecto            | Paxos (Antes)               | Blockchain (Depois)           |
| ------------------ | --------------------------- | ----------------------------- |
| **Complexidade**   | ~500 linhas customizadas    | ~100 linhas padronizadas      |
| **Confiabilidade** | Implementa√ß√£o manual        | Protocolo testado em produ√ß√£o |
| **Auditabilidade** | Logs locais                 | Ledger imut√°vel e p√∫blico     |
| **Debugging**      | Dif√≠cil diagn√≥stico         | Ferramentas padr√£o (Hardhat)  |
| **Escalabilidade** | Limitada a n√≥s configurados | Rede Ethereum ilimitada       |
| **Transpar√™ncia**  | Opaca entre empresas        | Totalmente transparente       |

### Tipos de Transa√ß√£o

```typescript
interface BlockchainTransaction {
  type:
    | 'RESERVE_STATION'
    | 'CANCEL_RESERVATION'
    | 'CHARGE'
    | 'PAYMENT'
    | 'CONFIRM'
    | 'REJECT';
  data: {
    stationId?: number;
    userId?: string;
    startTime?: number;
    endTime?: number;
    chargeAmount?: number;
    reservationId?: number;
  };
}
```

---

## üì° Comunica√ß√£o MQTT

### T√≥picos e Mensagens

#### Empresa ‚Üí Clientes (Carros)

```typescript
// T√≥pico: company/{companyId}/cars/{carId}/response
{
  type: "reservation_confirmed",
  data: {
    reservationId: 123,
    stationId: 5,
    estimatedTime: "15 min"
  }
}
```

#### Empresa ‚Üí Esta√ß√µes

```typescript
// T√≥pico: company/{companyId}/stations/{stationId}/commands
{
  type: "reserve_station",
  data: {
    reservationId: 123,
    userId: "car456",
    startTime: 1640995200000
  }
}
```

#### Esta√ß√µes ‚Üí Empresa

```typescript
// T√≥pico: company/{companyId}/stations/{stationId}/status
{
  type: "status_update",
  data: {
    state: "charging", // "available" | "reserved" | "charging" | "maintenance"
    currentUser: "car456",
    chargeProgress: 65,
    estimatedCompletion: "10 min"
  }
}
```

### Configura√ß√£o MQTT

```typescript
const mqttConfig = {
  host: process.env.MQTT_HOST || 'localhost',
  port: parseInt(process.env.MQTT_PORT || '9001'),
  path: process.env.MQTT_PATH || '/',
  clientId: `server-${COMPANY_ID}-${Date.now()}`,
};
```

---

## üìÅ Estrutura de Arquivos

```
apps/server/
‚îú‚îÄ‚îÄ üìÑ package.json                    # Depend√™ncias e scripts
‚îú‚îÄ‚îÄ üìÑ hardhat.config.cjs               # Configura√ß√£o Ethereum
‚îú‚îÄ‚îÄ üìÑ blockchain-server.ts             # Servidor principal Elysia
‚îú‚îÄ‚îÄ üìÑ mqtt-server.ts                   # Cliente MQTT
‚îú‚îÄ‚îÄ üìÑ setup-blockchain.sh              # Script de configura√ß√£o
‚îú‚îÄ‚îÄ üìÑ test-blockchain-system.sh        # Testes do sistema
‚îú‚îÄ‚îÄ üìÑ NO-MOCKS-COMPLETED.md           # Documenta√ß√£o da migra√ß√£o
‚îú‚îÄ‚îÄ üìÑ BLOCKCHAIN-QUICKSTART.md        # Guia r√°pido
‚îÇ
‚îú‚îÄ‚îÄ üóÇÔ∏è contracts/                       # Smart contracts Solidity
‚îÇ   ‚îî‚îÄ‚îÄ üìÑ ChargingConsensus.sol        # Contrato principal
‚îÇ
‚îú‚îÄ‚îÄ üóÇÔ∏è src/
‚îÇ   ‚îú‚îÄ‚îÄ üìÑ blockchain-server.ts         # Servidor principal com blockchain
‚îÇ   ‚îú‚îÄ‚îÄ üìÑ mqtt-server.ts               # Servidor MQTT
‚îÇ   ‚îú‚îÄ‚îÄ üìÑ server.ts                    # Servidor HTTP legado (TCP)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üóÇÔ∏è routes/                      # Endpoints da API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ reserve.ts               # Reservar posto
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ reserve-blockchain.ts    # Reserva via blockchain
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ startCharging.ts         # Iniciar recarga
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ endCharging.ts           # Finalizar recarga
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ payment.ts               # Processar pagamento
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ registerStation.ts       # Registrar posto
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ registerCar.ts           # Registrar carro
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ getStationInfo.ts        # Info do posto
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ stationSuggetions.ts     # Sugest√µes de postos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ rechargeList.ts          # Lista de recargas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ router.ts                # Roteador HTTP
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ mqtt-router.ts           # Roteador MQTT
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üóÇÔ∏è utils/                       # Utilit√°rios
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ ethereum-consensus.ts    # Servi√ßo blockchain principal
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ logger.ts                # Sistema de logs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ types.ts                 # Tipos TypeScript
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ cities.ts                # Dados das cidades
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ computed-routes.ts       # Rotas pr√©-calculadas
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ curry.ts                 # Fun√ß√µes curry (legado)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üóÇÔ∏è data/                        # Dados do sistema
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÑ data.ts                  # Estados locais (cache)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÑ commit.ts                # Sistema de commits (legado)
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ üóÇÔ∏è schemas/                     # Valida√ß√£o Zod
‚îÇ       ‚îú‚îÄ‚îÄ üìÑ car.schema.ts            # Schema do carro
‚îÇ       ‚îú‚îÄ‚îÄ üìÑ user.schema.ts           # Schema do usu√°rio
‚îÇ       ‚îú‚îÄ‚îÄ üìÑ station.schema.ts        # Schema da esta√ß√£o
‚îÇ       ‚îî‚îÄ‚îÄ üìÑ location.schema.ts       # Schema de localiza√ß√£o
‚îÇ
‚îú‚îÄ‚îÄ üóÇÔ∏è artifacts/                       # Artifacts Hardhat (gerados)
‚îÇ   ‚îî‚îÄ‚îÄ üóÇÔ∏è contracts/
‚îÇ       ‚îî‚îÄ‚îÄ üóÇÔ∏è ChargingConsensus.sol/
‚îÇ           ‚îú‚îÄ‚îÄ üìÑ ChargingConsensus.json
‚îÇ           ‚îî‚îÄ‚îÄ üìÑ ChargingConsensus.dbg.json
‚îÇ
‚îî‚îÄ‚îÄ üóÇÔ∏è scripts/                         # Scripts de deploy
    ‚îî‚îÄ‚îÄ üìÑ deploy.js                    # Deploy do smart contract
```

---

## üìä Diagramas

### Diagrama de Componentes

```mermaid
graph TB
    subgraph "üåê API Layer"
        HTTP[HTTP REST API<br/>Elysia Server]
        MQTT[MQTT Server<br/>Paho Client]
    end

    subgraph "üß† Business Logic"
        Routes[Route Handlers<br/>reserve, startCharging, etc.]
        Validation[Schema Validation<br/>Zod Schemas]
    end

    subgraph "‚õìÔ∏è Blockchain Layer"
        Consensus[EthereumConsensus<br/>Service]
        Contract[Smart Contract<br/>ChargingConsensus.sol]
        Provider[Ethereum Provider<br/>ethers.js]
    end

    subgraph "üíæ Data Layer"
        LocalCache[Local Cache<br/>STATIONS, USERS, CHARGES]
        Blockchain[Blockchain State<br/>Immutable Ledger]
    end

    subgraph "üîß Infrastructure"
        Hardhat[Hardhat Network<br/>:8545]
        Logger[Logger Service<br/>react-native-logs]
    end

    HTTP --> Routes
    MQTT --> Routes
    Routes --> Validation
    Validation --> Consensus
    Consensus --> Contract
    Contract --> Provider
    Provider --> Hardhat

    Routes --> LocalCache
    Consensus --> Blockchain

    Routes --> Logger
    Consensus --> Logger

    classDef api fill:#e3f2fd
    classDef business fill:#f3e5f5
    classDef blockchain fill:#e8f5e8
    classDef data fill:#fff3e0
    classDef infra fill:#fce4ec

    class HTTP,MQTT api
    class Routes,Validation business
    class Consensus,Contract,Provider blockchain
    class LocalCache,Blockchain data
    class Hardhat,Logger infra
```

### Diagrama de Estados da Esta√ß√£o

```mermaid
stateDiagram-v2
    [*] --> Available
    Available --> Reserved: createReservation()
    Reserved --> Charging: startCharging()
    Charging --> Available: completeCharging()
    Reserved --> Available: cancelReservation()

    Available: üü¢ Dispon√≠vel
    Reserved: üü° Reservado
    Charging: üî¥ Carregando

    note right of Available
        Station idle, ready for new reservations
    end note

    note right of Reserved
        Station booked, waiting for car arrival
    end note

    note right of Charging
        Station actively charging a vehicle
    end note
```

### Arquitetura de Deployment

```mermaid
graph TB
    subgraph "üñ•Ô∏è Development Environment"
        Dev1[Company A Server<br/>:8095]
        Dev2[Company B Server<br/>:8096]
        DevBlockchain[Hardhat Network<br/>:8545]
    end

    subgraph "‚òÅÔ∏è Production Environment"
        Prod1[Company A Server<br/>Production]
        Prod2[Company B Server<br/>Production]
        ProdBlockchain[Ethereum Mainnet<br/>or Sepolia Testnet]
    end

    subgraph "üì± Client Applications"
        MobileApp[React Native App<br/>Car Interface]
        WebDashboard[Web Dashboard<br/>Company Admin]
        StationSim[Station Simulator<br/>MQTT Devices]
    end

    Dev1 --> DevBlockchain
    Dev2 --> DevBlockchain

    Prod1 --> ProdBlockchain
    Prod2 --> ProdBlockchain

    MobileApp -.->|MQTT + HTTP| Dev1
    WebDashboard -.->|HTTP| Prod1
    StationSim -.->|MQTT| Dev2

    classDef dev fill:#e8f5e8
    classDef prod fill:#ffebee
    classDef client fill:#e3f2fd

    class Dev1,Dev2,DevBlockchain dev
    class Prod1,Prod2,ProdBlockchain prod
    class MobileApp,WebDashboard,StationSim client
```

---

## ‚öôÔ∏è Configura√ß√£o e Deploy

### Vari√°veis de Ambiente

```bash
# Identifica√ß√£o da empresa
COMPANY_ID=company-a                    # ID √∫nico da empresa

# Configura√ß√£o do servidor
SERVER_PORT=3001                       # Porta do servidor HTTP
NODE_ENV=development                    # Ambiente de execu√ß√£o

# Configura√ß√£o blockchain
ETHEREUM_RPC_URL=http://localhost:8545  # URL do n√≥ Ethereum
PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
CONTRACT_ADDRESS=0x5FbDB2315678afecb367f032d93F642f64180aa3

# Configura√ß√£o MQTT
MQTT_HOST=localhost                     # Broker MQTT
MQTT_PORT=9001                         # Porta WebSocket MQTT
MQTT_PATH=/                            # Caminho WebSocket
```

### Scripts de Deploy

```bash
# Desenvolvimento
yarn blockchain:start                   # Inicia rede Hardhat
yarn blockchain:compile                 # Compila smart contracts
yarn dev                              # Inicia servidor de desenvolvimento

# Teste
yarn test                             # Executa testes completos
yarn blockchain:test                  # Testes espec√≠ficos do blockchain

# Produ√ß√£o
yarn start                            # Inicia servidor de produ√ß√£o
SERVER_PORT=8095 COMPANY_ID=company-a yarn start  # Multi-empresa
```

### Setup Multi-Empresa

```bash
# Terminal 1: Blockchain Network
cd apps/server
npx hardhat node --port 8545

# Terminal 2: Empresa A
SERVER_PORT=8095 COMPANY_ID=company-a bun run src/blockchain-server.ts

# Terminal 3: Empresa B
SERVER_PORT=8096 COMPANY_ID=company-b bun run src/blockchain-server.ts

# Terminal 4: Empresa C
SERVER_PORT=8097 COMPANY_ID=company-c bun run src/blockchain-server.ts
```

### Docker Compose (Opcional)

```yaml
version: '3.8'
services:
  blockchain:
    image: ethereum/client-go:stable
    ports:
      - '8545:8545'

  company-a:
    build: .
    ports:
      - '8095:3000'
    environment:
      - COMPANY_ID=company-a
      - ETHEREUM_RPC_URL=http://blockchain:8545
    depends_on:
      - blockchain

  company-b:
    build: .
    ports:
      - '8096:3000'
    environment:
      - COMPANY_ID=company-b
      - ETHEREUM_RPC_URL=http://blockchain:8545
    depends_on:
      - blockchain

  mqtt-broker:
    image: eclipse-mosquitto:2
    ports:
      - '1883:1883'
      - '9001:9001'
```

---

## üéØ Considera√ß√µes Finais

### ‚úÖ Status Atual

- **Blockchain Consensus**: ‚úÖ Operacional
- **Multi-Empresa**: ‚úÖ Funcional
- **API REST**: ‚úÖ Todos endpoints implementados
- **MQTT**: ‚úÖ Comunica√ß√£o em tempo real
- **Smart Contracts**: ‚úÖ Deployed e testados
- **Migra√ß√£o Paxos**: ‚úÖ Conclu√≠da com sucesso

### üöß Melhorias Futuras

1. **Performance**: Implementar cache distribu√≠do Redis
2. **Monitoring**: Adicionar m√©tricas Prometheus + Grafana
3. **Security**: Implementar autentica√ß√£o JWT e rate limiting
4. **Scalability**: Deploy em Kubernetes com auto-scaling
5. **Mobile**: Desenvolver app React Native para motoristas
6. **Analytics**: Dashboard em tempo real para operadores

### üìö Documenta√ß√£o Relacionada

- [`BLOCKCHAIN-QUICKSTART.md`](./BLOCKCHAIN-QUICKSTART.md) - Guia r√°pido
- [`NO-MOCKS-COMPLETED.md`](./NO-MOCKS-COMPLETED.md) - Documenta√ß√£o da migra√ß√£o
- [`contracts/ChargingConsensus.sol`](./contracts/ChargingConsensus.sol) - Smart contract
- [`docs/blockchain-migration-complete.md`](../docs/blockchain-migration-complete.md) - Relat√≥rio completo

---

_Documenta√ß√£o gerada para o sistema de recarga de VEs com blockchain - v1.0.0_
